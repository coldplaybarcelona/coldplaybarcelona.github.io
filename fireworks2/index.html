<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fireworks en funció d'àudio</title>
  <style>
    body { margin: 0; overflow: hidden; background-color: #000; }
    #fireworks { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
    #uploader { position: fixed; top: 10px; left: 10px; z-index: 10; }
    #debug-info, #error-info {
      position: fixed; left: 10px; color: #FFF; background: rgba(0, 0, 0, 0.5);
      padding: 10px; font-family: Arial, sans-serif; font-size: 14px; z-index: 10;
    }
    #debug-info { top: 40px; }
    #error-info { bottom: 10px; }
  </style>
</head>
<body>
  <input type="file" id="uploader" accept="audio/*">
  <div id="fireworks"></div>
  
  <div id="debug-info">
    <div>Intensitat: <span id="intensity-value">0</span></div>
    <div>Particles: <span id="particles-value">0</span></div>
    <div>Interval: <span id="interval-value">0</span> ms</div>
    <div>Brillantor: <span id="brightness-value">0</span></div>
    <div>Decay: <span id="decay-value">0</span></div>
    <div>Frequència mitjana: <span id="frequency-value">0</span></div>
  </div>

  <div id="error-info">
    <div>Error: <span id="error-message">No errors</span></div>
    <div>Causa de l'error: <span id="error-cause">N/A</span></div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/fireworks-js@2.8.0/dist/index.umd.js"></script>
  <script>
    const container = document.getElementById('fireworks');
    const uploader = document.getElementById("uploader");
    let fireworks;
    
    let audioContext, analyser, dataArray;

    const intensityEl = document.getElementById("intensity-value");
    const particlesEl = document.getElementById("particles-value");
    const intervalEl = document.getElementById("interval-value");
    const brightnessEl = document.getElementById("brightness-value");
    const decayEl = document.getElementById("decay-value");
    const frequencyEl = document.getElementById("frequency-value");
    const errorMessageEl = document.getElementById("error-message");
    const errorCauseEl = document.getElementById("error-cause");

    uploader.onchange = async (event) => {
      try {
        const file = event.target.files[0];
        if (file && file.type.startsWith("audio/")) {
          const audioData = await file.arrayBuffer();
          startAudioProcessing(audioData);
        } else {
          throw new Error("Si us plau, puja un fitxer d'àudio.");
        }
      } catch (error) {
        errorMessageEl.textContent = error.message;
        errorCauseEl.textContent = error.cause || "No disponible";
      }
    };

    function startAudioProcessing(audioData) {
      try {
        if (audioContext) {
          audioContext.close();
        }
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        audioContext.decodeAudioData(audioData, (buffer) => {
          const source = audioContext.createBufferSource();
          source.buffer = buffer;

          analyser = audioContext.createAnalyser();
          analyser.fftSize = 256;
          const bufferLength = analyser.frequencyBinCount;
          dataArray = new Uint8Array(bufferLength);

          source.connect(analyser);
          analyser.connect(audioContext.destination);
          source.start();

          if (!fireworks) {
            fireworks = new Fireworks.default(container);
            fireworks.start();
          }
          animateFireworks();
        });
      } catch (error) {
        errorMessageEl.textContent = error.message;
        errorCauseEl.textContent = error.cause || "No disponible";
      }
    }

    function animateFireworks() {
      requestAnimationFrame(animateFireworks);
      
      if (!analyser || !dataArray) return;

      analyser.getByteFrequencyData(dataArray);

      const avgFrequency = dataArray.reduce((a, b) => a + b) / dataArray.length;
      const intensity = Math.min(avgFrequency / 128, 1);
      const rocketSpawnInterval = Math.max(30, 100 - avgFrequency);

      fireworks.updateOptions({
        particles: Math.floor(50 + intensity * 150),
        delay: { min: rocketSpawnInterval, max: rocketSpawnInterval + 20 },
        brightness: { min: 50, max: Math.floor(50 + intensity * 50) },
        decay: { min: Math.max(0.015, intensity * 0.03), max: Math.max(0.03, intensity * 0.05) },
      });

      intensityEl.textContent = intensity.toFixed(2);
      particlesEl.textContent = Math.floor(50 + intensity * 150);
      intervalEl.textContent = rocketSpawnInterval.toFixed(0);
      brightnessEl.textContent = (50 + intensity * 50).toFixed(2);
      decayEl.textContent = `${Math.max(0.015, intensity * 0.03).toFixed(3)} - ${Math.max(0.03, intensity * 0.05).toFixed(3)}`;
      frequencyEl.textContent = avgFrequency.toFixed(2);
    }
    
    // Initialize fireworks
    fireworks = new Fireworks.default(container);
    fireworks.start();
    
  </script>
</body>
</html>